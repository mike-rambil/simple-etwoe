name: API E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-api:
    name: Run API Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ”§ Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: âœ… Make test script executable
        run: chmod +x run_tests.sh

      - name: ğŸš€ Run E2E API tests
        run: ./run_tests.sh

      - name: Check test result and write PR comment
        if: always() # ensures this runs even if prior step fails
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const isSuccess = ${{
              steps.test_api.outcome == 'success' ? 'true' : 'false'
            }};

            const pr = github.context.payload.pull_request;
            if (!pr) {
              console.log("No PR context available. Skipping comment.");
              return;
            }

            if (isSuccess) {
              github.rest.issues.createComment({
                issue_number: pr.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: "âœ… All E2E tests passed. Great job!"
              });
            } else {
              github.rest.issues.createComment({
                issue_number: pr.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: "âŒ Some E2E tests failed. Please check the diff logs in CI and resolve before merging."
              });

              github.rest.pulls.createReview({
                pull_number: pr.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                event: "REQUEST_CHANGES",
                body: "E2E test failure detected. Fix the issues and push an update."
              });
            }
